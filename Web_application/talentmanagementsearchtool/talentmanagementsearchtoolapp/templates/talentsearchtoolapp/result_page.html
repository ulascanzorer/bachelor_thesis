{% load render_table from django_tables2 %}
{% load django_bootstrap5 %}

{% bootstrap_css %}
{% bootstrap_javascript %}

{% block bootstrap5_content %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{% block title %}{{ title }}{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'talentsearchtoolapp/result_page.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/intro.js/introjs.css">
    <title>Result View</title>
</head>
<body>
    <div id="filters-div" style="display: none;">
        <form class="form-inline" method="GET">
            <!-- Hidden input to hold on to the task_id parameter, instead of losing it when the form is submitted.-->
    
            <input type="hidden" name="task_id" value="{{ task_id }}">
    
    
            <!-- gender filter input -->
    
            <div class="form-group" id="gender-selection-div">
                <strong class="sl">Select gender:</strong>
    
                <select class="form-select" name="gender" id="gender" multiple="multiple">
                    <option value="male" {% if "male" in selected_genders %}selected{% endif %}>Male</option>
                    <option value="female" {% if "female" in selected_genders %}selected{% endif %}>Female</option>
                    <option value="unknown" {% if "unknown" in selected_genders %}selected{% endif %}>Unknown</option>
                </select>
            </div>
    
            <br>
    
            <!-- relevant_work_count filter input -->
    
            <div class="input-group" id="relevant_work_count-div">
                <div class="my-input-group">
                    <strong class="sl">Minimum relevant work count:</strong>
                    <input type="number" class="form-control" id="min_relevant_work_count" name="min_relevant_work_count" value="{{ request.GET.min_relevant_work_count }}" min="0">
    
                    <strong class="sl">Maximum relevant work count:</strong>
                    <input type="number" class="form-control" id="max_relevant_work_count" name="max_relevant_work_count" value="{{ request.GET.max_relevant_work_count }}" min="0">
                </div>
            </div>
    
            <br>
    
            <!-- relevant_work_ratio filter input -->
    
            <div class="input-group" id="relevant_work_ratio-div">
                <div class="my-input-group">
                    <strong class="sl">Minimum relevant work ratio:</strong>
                    <input type="number" class="form-control" step="0.01" id="min_relevant_work_ratio" name="min_relevant_work_ratio" value="{{ request.GET.min_relevant_work_ratio }}" min="0" max="1">
    
                    <strong class="sl">Maximum relevant work ratio:</strong>
                    <input type="number" class="form-control" step="0.01" id="max_relevant_work_ratio" name="max_relevant_work_ratio" value="{{ request.GET.max_relevant_work_ratio }}" min="0" max="1">
                </div>
            </div>
    
            <br>
    
            <!-- only_author_count filter input -->
    
            <div class="input-group" id="only_author_count-div">
                <div class="my-input-group">
                    <strong class="sl">Minimum only author count:</strong>
                    <input type="number" class="form-control" id="min_only_author_count" name="min_only_author_count" value="{{ request.GET.min_only_author_count }}" min="0">
    
                    <strong class="sl">Maximum only author count:</strong>
                    <input type="number" class="form-control" id="max_only_author_count" name="max_only_author_count" value="{{ request.GET.max_only_author_count }}" min="0">
                </div>
            </div>
    
            <br>
    
            <!-- first_author_count filter input -->
    
            <div class="input-group" id="first_author_count-div">
                <div class="my-input-group">
                    <strong class="sl">Minimum first author count:</strong>
                    <input type="number" class="form-control" id="min_first_author_count" name="min_first_author_count" value="{{ request.GET.min_first_author_count }}" min="0">
    
                    <strong class="sl">Maximum first author count:</strong>
                    <input type="number" class="form-control" id="max_first_author_count" name="max_first_author_count" value="{{ request.GET.max_first_author_count }}" min="0">
                </div>
            </div>
    
            <br>
    
            <!-- last_author_count filter input -->
    
            <div class="input-group" id="last_author_count-div">
                <div class="my-input-group">
                    <strong class="sl">Minimum last author count:</strong>
                    <input type="number" class="form-control" id="min_last_author_count" name="min_last_author_count" value="{{ request.GET.min_last_author_count }}" min="0">
    
                    <strong class="sl">Maximum last author count:</strong>
                    <input type="number" class="form-control" id="max_last_author_count" name="max_last_author_count" value="{{ request.GET.max_last_author_count }}" min="0">
                </div>
            </div>
    
            <br>
    
            <!-- co_author_count filter input -->
    
            <div class="input-group" id="co_author_count-div">
                <div class="my-input-group">
                    <strong class="sl">Minimum co-author count:</strong>
                    <input type="number" class="form-control" id="min_co_author_count" name="min_co_author_count" value="{{ request.GET.min_co_author_count }}" min="0">
    
                    <strong class="sl">Maximum co-author count:</strong>
                    <input type="number" class="form-control" id="max_co_author_count" name="max_co_author_count" value="{{ request.GET.max_co_author_count }}" min="0">
                </div>
            </div>
    
            <br>
    
            <!-- unknown_count filter input -->
    
            <div class="input-group" id="unknown_count-div">
                <div class="my-input-group">
                    <strong class="sl">Minimum unknown count:</strong>
                    <input type="number" class="form-control" id="min_unknown_count" name="min_unknown_count" value="{{ request.GET.min_unknown_count }}" min="0">
    
                    <strong class="sl">Maximum unknown count:</strong>
                    <input type="number" class="form-control" id="max_unknown_count" name="max_unknown_count" value="{{ request.GET.max_unknown_count }}" min="0">
                </div>
            </div>
    
    
            <button class="btn btn-primary" id="filter-button" type="submit">Filter</button>
        </form>
    </div>
    
    <br>

    <div id="toggle-filters-div">
        <button class="btn btn-secondary" id="toggle-filters-button">Toggle filters</button>
    </div>

    <br>

    <div id="download-as-csv-div">
        <button class="btn btn-primary" id="download-as-csv-button">Download results as a CSV file</button>
    </div>

    <br>

    <h3>
        <strong class="sl">Original query:</strong>
        {% for element in original_query %}
            {{ element }}
            {% if not forloop.last %}
                ,&nbsp;
            {% endif %}
        {% endfor %}
    </h3>

    <br>

    {% render_table table %}

    <script src="https://unpkg.com/intro.js/intro.js"></script>
    <script>
        // Script for multiple selection for the gender.

        const selectElement = document.getElementById("gender");
        const options = selectElement.getElementsByTagName("option");

        selectElement.onmousedown= function(event) {
            event.preventDefault();
        }
        selectElement.onmousemove= function(event) {
            event.preventDefault();
        }

        for (let i = 0; i < options.length; i++) {
            options[i].addEventListener("click", function() {
                if (this.hasAttribute("selected")) {
                    this.removeAttribute("selected");
                } else {
                    this.setAttribute("selected", "");
                }
            })
        }

        // Script for showing or hiding the filters.

        document.getElementById("toggle-filters-button").addEventListener("click", function() {
            const filtersDiv = document.getElementById("filters-div");
            
            if (filtersDiv.style.display === "none") {
                filtersDiv.style.display = "block";
            } else {
                filtersDiv.style.display = "none";
            }
        });

        // Script for clicking the download as csv button.

        const downloadButton = document.getElementById("download-as-csv-button");
        downloadButton.addEventListener("click", function() {
            const currentUrl = window.location.href;

            const separator = currentUrl.indexOf("?") !== -1 ? "&" : "?";

            const newUrl = currentUrl + separator + "_export=csv";

            window.location.href = newUrl;
        });

        // Dealing with the tutorial.

        const tutorialStatus = sessionStorage.getItem("tutorial");
        
        if (tutorialStatus == "true") {
            const toggleFiltersButton = document.getElementById("toggle-filters-button");

            const initialIntroJsInstance = introJs().setOptions({
                steps: [
                    {
                        intro: "This is an example results page. We shall now go over the functionalities.",
                    },
                    {
                        element: toggleFiltersButton,
                        intro: "You can click on this button to display or hide the filters.",
                    },
                ]
            });

            const filtersIntroJsInstance = introJs().setOptions({
                steps: [
                    {
                        intro: "Here you can see various filters that can be set."
                    },
                    {
                        element: document.getElementById("gender-selection-div"),
                        intro: "You can select the gender of the authors, multiple selection is also allowed.",
                    },
                    {
                        element: document.getElementById("relevant_work_count-div"),
                        intro: "You can select the minimum and maximum number of works that an author must have which are related to the search.",
                    },
                    {
                        element: document.getElementById("relevant_work_ratio-div"),
                        intro: "You can specify to show only the authors, who have a ratio of the number of their related works to the number of all their works, which is between the given minimum and maximum ratios.",
                    },
                    {
                        element: document.getElementById("only_author_count-div"),
                        intro: "You can specify the number of related works that an author must have, where they are the only author.",
                    },
                    {
                        element: document.getElementById("first_author_count-div"),
                        intro: "You can specify the number of related works that an author must have, where they are the first author.",
                    },
                    {
                        element: document.getElementById("last_author_count-div"),
                        intro: "You can specify the number of related works that an author must have, where they are the last author.",
                    },
                    {
                        element: document.getElementById("co_author_count-div"),
                        intro: "You can specify the number of related works that an author must have, where they are a co-author, which in our case means where they were neither the only author, nor the first author, nor the last author, but somewhere in the middle of the list of contributors of a work.",
                    },
                    {
                        element: document.getElementById("unknown_count-div"),
                        intro: "You can specify the number of related works that an author must have, where their role could not be determined.",
                    },
                    {
                        element: document.getElementById("filter-button"),
                        intro: "After selecting all the filters you can click on this button to get the filtered results.",
                    }
                ]
            });

            let relevantWorkCountElement;

            const elements = document.getElementsByTagName("*");

            for (const element of elements) {
                if (element.innerHTML === "Relevant work count") {
                    relevantWorkCountElement = element;
                    break;
                }
            }

            const finalIntroJsInstance = introJs().setOptions({
                steps: [
                    {
                        element: relevantWorkCountElement,
                        intro: "You can also click on the fields manually in order to sort by a specific field. You can sort by the field in ascending or descending order if you click more than once.",
                    },
                    {
                        element: downloadButton,
                        intro: "You can also press the download button to download the results as a CSV file.",
                    },
                    {
                        intro: "The tutorial is now done. Feel free to try out the filtering options, download the sample results as a CSV file, or go back to the home page to search with your own options. Have fun!",
                    },
                ]
            })

            initialIntroJsInstance.onexit(function () {
                toggleFiltersButton.click();
                filtersIntroJsInstance.start();
            });

            filtersIntroJsInstance.onexit(function () {
                toggleFiltersButton.click();
                finalIntroJsInstance.start();
            });

            finalIntroJsInstance.onexit(function () {
                sessionStorage.setItem("tutorial", "false");
            })

            initialIntroJsInstance.start();
        }

    </script>   
</body>
</html>
{% endblock %}